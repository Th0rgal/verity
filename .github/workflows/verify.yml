name: Verify proofs

on:
  push:
    branches: [main]
    paths:
      - 'DumbContracts/**'
      - 'DumbContracts.lean'
      - 'Compiler/**'
      - 'Compiler.lean'
      - 'examples/solidity/**'
      - 'lakefile.lean'
      - 'lean-toolchain'
  pull_request:
    paths:
      - 'DumbContracts/**'
      - 'DumbContracts.lean'
      - 'Compiler/**'
      - 'Compiler.lean'
      - 'examples/solidity/**'
      - 'lakefile.lean'
      - 'lean-toolchain'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    # Skip verification for draft PRs
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false
    steps:
      - uses: actions/checkout@v4

      - name: Install elan
        run: |
          curl -sSf https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh | sh -s -- -y --default-toolchain none
          echo "$HOME/.elan/bin" >> $GITHUB_PATH

      - name: Cache Lake packages
        uses: actions/cache@v4
        with:
          path: .lake
          key: lake-${{ hashFiles('lean-toolchain') }}-${{ hashFiles('lakefile.lean') }}
          restore-keys: lake-${{ hashFiles('lean-toolchain') }}-

      - name: Build and verify all proofs
        run: lake build

      - name: Check for sorry
        run: |
          if grep -r "sorry" DumbContracts/Proofs/ --include="*.lean" | grep -v "^--" | grep -v "zero sorry" | grep -v "Summary"; then
            echo "ERROR: Found 'sorry' in proof files"
            exit 1
          fi
          echo "No sorry found â€” all proofs are complete"

  foundry:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install elan
        run: |
          curl -sSf https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh | sh -s -- -y --default-toolchain none
          echo "$HOME/.elan/bin" >> $GITHUB_PATH

      - name: Cache Lake packages
        uses: actions/cache@v4
        with:
          path: .lake
          key: lake-${{ hashFiles('lean-toolchain') }}-${{ hashFiles('lakefile.lean') }}
          restore-keys: lake-${{ hashFiles('lean-toolchain') }}-

      - name: Build compiler
        run: lake build dumbcontracts-compiler

      - name: Build difftest interpreter
        run: lake build difftest-interpreter

      - name: Generate Yul
        run: ./.lake/build/bin/dumbcontracts-compiler

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: v1.5.0

      - name: Install solc
        run: |
          curl -L https://binaries.soliditylang.org/linux-amd64/solc-linux-amd64-v0.8.33+commit.64118f21 -o /usr/local/bin/solc
          chmod +x /usr/local/bin/solc
          solc --version

      - name: Run Foundry tests
        env:
          DIFFTEST_RANDOM_SMALL: "100"
          DIFFTEST_RANDOM_LARGE: "1000"
          DIFFTEST_RANDOM_SEED: "42"
        run: forge test
