name: Verify proofs

on:
  push:
    branches: [main]
    paths:
      - 'DumbContracts/**'
      - 'DumbContracts.lean'
      - 'examples/solidity/**'
      - 'lakefile.lean'
      - 'lean-toolchain'
  pull_request:
    paths:
      - 'DumbContracts/**'
      - 'DumbContracts.lean'
      - 'examples/solidity/**'
      - 'lakefile.lean'
      - 'lean-toolchain'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    # Skip verification for draft PRs
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false
    steps:
      - uses: actions/checkout@v4

      - name: Install elan
        run: |
          curl -sSf https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh | sh -s -- -y --default-toolchain none
          echo "$HOME/.elan/bin" >> $GITHUB_PATH

      - name: Cache Lake packages
        uses: actions/cache@v4
        with:
          path: .lake
          key: lake-${{ hashFiles('lean-toolchain') }}-${{ hashFiles('lakefile.lean') }}
          restore-keys: lake-${{ hashFiles('lean-toolchain') }}-

      - name: Build and verify all proofs
        run: lake build

      - name: Check for sorry
        run: |
          if grep -r "sorry" DumbContracts/Proofs/ --include="*.lean" | grep -v "^--" | grep -v "zero sorry" | grep -v "Summary"; then
            echo "ERROR: Found 'sorry' in proof files"
            exit 1
          fi
          echo "No sorry found â€” all proofs are complete"
