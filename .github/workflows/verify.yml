name: Verify proofs

on:
  push:
    branches: [main]
    paths:
      - 'DumbContracts/**'
      - 'DumbContracts.lean'
      - 'Compiler/**'
      - 'Compiler.lean'
      - 'examples/solidity/**'
      - 'lakefile.lean'
      - 'lean-toolchain'
  pull_request:
    paths:
      - 'DumbContracts/**'
      - 'DumbContracts.lean'
      - 'Compiler/**'
      - 'Compiler.lean'
      - 'examples/solidity/**'
      - 'lakefile.lean'
      - 'lean-toolchain'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    # Skip verification for draft PRs
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false
    steps:
      - uses: actions/checkout@v4

      - name: Install elan
        run: |
          curl -sSf https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh | sh -s -- -y --default-toolchain none
          echo "$HOME/.elan/bin" >> $GITHUB_PATH

      - name: Cache Lake packages
        uses: actions/cache@v4
        with:
          path: .lake
          key: lake-${{ hashFiles('lean-toolchain') }}-${{ hashFiles('lakefile.lean') }}
          restore-keys: lake-${{ hashFiles('lean-toolchain') }}-

      - name: Build and verify all proofs
        run: lake build

      - name: Check for sorry
        run: |
          if grep -r "sorry" DumbContracts/Proofs/ --include="*.lean" | grep -v "^--" | grep -v "zero sorry" | grep -v "Summary"; then
            echo "ERROR: Found 'sorry' in proof files"
            exit 1
          fi
          echo "No sorry found â€” all proofs are complete"

      - name: Build compiler
        run: lake build dumbcontracts-compiler

      - name: Build difftest interpreter
        run: lake build difftest-interpreter

      - name: Generate Yul
        run: ./.lake/build/bin/dumbcontracts-compiler

      - name: Check selector hashing against specs
        run: python3 scripts/check_selectors.py

      - name: Install solc
        run: |
          sudo curl -L https://binaries.soliditylang.org/linux-amd64/solc-linux-amd64-v0.8.33+commit.64118f21 -o /usr/local/bin/solc
          sudo chmod +x /usr/local/bin/solc
          solc --version

      - name: Compile generated Yul with solc
        run: python3 scripts/check_yul_compiles.py

      - name: Check selector fixtures against solc
        run: python3 scripts/check_selector_fixtures.py

      - name: Check property manifest references
        run: python3 scripts/check_property_manifest.py

      - name: Check property manifest sync
        run: python3 scripts/check_property_manifest_sync.py

      - name: Check property coverage
        run: python3 scripts/check_property_coverage.py

      - name: Upload generated Yul
        uses: actions/upload-artifact@v4
        with:
          name: generated-yul
          path: |
            compiler/yul
            compiler/yul-new

      - name: Upload difftest interpreter
        uses: actions/upload-artifact@v4
        with:
          name: difftest-interpreter
          path: .lake/build/bin/difftest-interpreter

  foundry:
    runs-on: ubuntu-latest
    needs: build
    strategy:
      fail-fast: false
      matrix:
        shard_index: [0, 1, 2, 3, 4, 5, 6, 7]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download generated Yul
        uses: actions/download-artifact@v4
        with:
          name: generated-yul
          path: compiler

      - name: Download difftest interpreter
        uses: actions/download-artifact@v4
        with:
          name: difftest-interpreter
          path: .lake/build/bin

      - name: Make difftest interpreter executable
        run: |
          chmod +x .lake/build/bin/difftest-interpreter
          ls -l .lake/build/bin/difftest-interpreter

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: v1.5.0

      - name: Install solc
        run: |
          sudo curl -L https://binaries.soliditylang.org/linux-amd64/solc-linux-amd64-v0.8.33+commit.64118f21 -o /usr/local/bin/solc
          sudo chmod +x /usr/local/bin/solc
          solc --version

      - name: Run Foundry tests
        env:
          DIFFTEST_RANDOM_SMALL: "100"
          DIFFTEST_RANDOM_LARGE: "10000"
          DIFFTEST_RANDOM_SEED: "42"
          DIFFTEST_SHARD_COUNT: "8"
          DIFFTEST_SHARD_INDEX: "${{ matrix.shard_index }}"
        run: forge test
