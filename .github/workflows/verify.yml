name: Verify proofs

on:
  push:
    branches: [main]
    paths:
      - 'DumbContracts/**'
      - 'DumbContracts.lean'
      - 'Compiler/**'
      - 'Compiler.lean'
      - 'examples/solidity/**'
      - 'test/**'
      - 'scripts/**'
      - 'lakefile.lean'
      - 'lean-toolchain'
  pull_request:
    paths:
      - 'DumbContracts/**'
      - 'DumbContracts.lean'
      - 'Compiler/**'
      - 'Compiler.lean'
      - 'examples/solidity/**'
      - 'test/**'
      - 'scripts/**'
      - 'lakefile.lean'
      - 'lean-toolchain'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    # Skip verification for draft PRs
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false
    steps:
      - uses: actions/checkout@v4

      - name: Install elan
        run: |
          curl -sSf https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh | sh -s -- -y --default-toolchain none
          echo "$HOME/.elan/bin" >> $GITHUB_PATH

      - name: Cache Lake packages
        uses: actions/cache@v4
        with:
          path: .lake
          key: lake-${{ hashFiles('lean-toolchain') }}-${{ hashFiles('lakefile.lean') }}
          restore-keys: lake-${{ hashFiles('lean-toolchain') }}-

      - name: Build and verify all proofs
        run: lake build

      - name: Check for sorry
        run: |
          if grep -r "sorry" DumbContracts/Proofs/ --include="*.lean" | grep -v "^--" | grep -v "zero sorry" | grep -v "Summary"; then
            echo "ERROR: Found 'sorry' in proof files"
            exit 1
          fi
          echo "No sorry found — all proofs are complete"

      - name: Check for axioms in proof files
        run: |
          echo "Checking for axioms in Compiler/ and DumbContracts/..."

          # Find all axioms across both directories (excluding commented lines)
          grep -rn "^axiom " Compiler/ DumbContracts/ --include="*.lean" | tee axioms.txt || true

          # Count axioms
          AXIOM_COUNT=$(wc -l < axioms.txt 2>/dev/null | tr -d ' ')

          echo "Found $AXIOM_COUNT axiom declaration(s)"

          if [ "$AXIOM_COUNT" -gt 0 ]; then
            echo "::warning::Found $AXIOM_COUNT axiom(s) in proof files"
            cat axioms.txt

            # Check if AXIOMS.md exists
            if [ ! -f "AXIOMS.md" ]; then
              echo "::error::AXIOMS.md not found. All axioms must be documented."
              exit 1
            fi

            # Verify each axiom is documented in AXIOMS.md
            echo "Verifying all axioms are documented..."

            # Extract axiom names from grep output
            AXIOM_NAMES=$(sed 's/.*:axiom \([a-zA-Z0-9_]*\).*/\1/' axioms.txt | sort -u)

            UNDOCUMENTED=""
            for axiom_name in $AXIOM_NAMES; do
              if ! grep -q "$axiom_name" AXIOMS.md; then
                echo "::error::Axiom '$axiom_name' not documented in AXIOMS.md"
                UNDOCUMENTED="$UNDOCUMENTED $axiom_name"
              else
                echo "✓ Axiom '$axiom_name' is documented"
              fi
            done

            if [ -n "$UNDOCUMENTED" ]; then
              echo "::error::Undocumented axioms:$UNDOCUMENTED"
              exit 1
            fi

            echo "✓ All $AXIOM_COUNT axioms are documented in AXIOMS.md"
          else
            echo "✓ No axioms found in proof files"
          fi

      - name: Build compiler
        run: lake build dumbcontracts-compiler

      - name: Build difftest interpreter
        run: lake build difftest-interpreter

      - name: Generate Yul
        run: ./.lake/build/bin/dumbcontracts-compiler

      - name: Check selector hashing against specs
        run: python3 scripts/check_selectors.py

      - name: Validate Selectors.lean axiom definitions
        run: python3 scripts/validate_selectors.py

      - name: Install solc
        run: |
          sudo curl -L https://binaries.soliditylang.org/linux-amd64/solc-linux-amd64-v0.8.33+commit.64118f21 -o /usr/local/bin/solc
          sudo chmod +x /usr/local/bin/solc
          solc --version

      - name: Compile generated Yul with solc
        run: python3 scripts/check_yul_compiles.py

      - name: Check selector fixtures against solc
        run: python3 scripts/check_selector_fixtures.py

      - name: Check property manifest references
        run: python3 scripts/check_property_manifest.py

      - name: Check property manifest sync
        run: python3 scripts/check_property_manifest_sync.py

      - name: Check property coverage
        run: python3 scripts/check_property_coverage.py

      - name: Check storage layout consistency
        run: python3 scripts/check_storage_layout.py

      - name: Check contract file structure
        run: python3 scripts/check_contract_structure.py

      - name: Check axiom locations in AXIOMS.md
        run: python3 scripts/check_axiom_locations.py

      - name: Check documentation counts
        run: python3 scripts/check_doc_counts.py

      - name: Generate property coverage report
        run: python3 scripts/report_property_coverage.py --format=markdown >> $GITHUB_STEP_SUMMARY

      - name: Generate storage layout report
        run: python3 scripts/check_storage_layout.py --format=markdown >> $GITHUB_STEP_SUMMARY

      - name: Upload generated Yul
        uses: actions/upload-artifact@v4
        with:
          name: generated-yul
          path: compiler/yul

      - name: Upload difftest interpreter
        uses: actions/upload-artifact@v4
        with:
          name: difftest-interpreter
          path: .lake/build/bin/difftest-interpreter

  foundry:
    runs-on: ubuntu-latest
    needs: build
    strategy:
      fail-fast: false
      matrix:
        shard_index: [0, 1, 2, 3, 4, 5, 6, 7]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download generated Yul
        uses: actions/download-artifact@v4
        with:
          name: generated-yul
          path: compiler

      - name: Download difftest interpreter
        uses: actions/download-artifact@v4
        with:
          name: difftest-interpreter
          path: .lake/build/bin

      - name: Make difftest interpreter executable
        run: |
          chmod +x .lake/build/bin/difftest-interpreter
          ls -l .lake/build/bin/difftest-interpreter

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: v1.5.0

      - name: Install solc
        run: |
          sudo curl -L https://binaries.soliditylang.org/linux-amd64/solc-linux-amd64-v0.8.33+commit.64118f21 -o /usr/local/bin/solc
          sudo chmod +x /usr/local/bin/solc
          solc --version

      - name: Run Foundry tests with seed 42
        env:
          DIFFTEST_RANDOM_SMALL: "100"
          DIFFTEST_RANDOM_LARGE: "10000"
          DIFFTEST_RANDOM_SEED: "42"
          DIFFTEST_SHARD_COUNT: "8"
          DIFFTEST_SHARD_INDEX: "${{ matrix.shard_index }}"
        run: |
          echo "Running tests with seed 42 (shard ${{ matrix.shard_index }}/8)"
          forge test

  # Multi-seed testing to detect flakiness and seed-dependent failures
  foundry-multi-seed:
    runs-on: ubuntu-latest
    needs: build
    strategy:
      fail-fast: false  # Test all seeds even if one fails
      matrix:
        seed: [0, 1, 42, 123, 999, 12345, 67890]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download generated Yul
        uses: actions/download-artifact@v4
        with:
          name: generated-yul
          path: compiler

      - name: Download difftest interpreter
        uses: actions/download-artifact@v4
        with:
          name: difftest-interpreter
          path: .lake/build/bin

      - name: Make difftest interpreter executable
        run: |
          chmod +x .lake/build/bin/difftest-interpreter
          ls -l .lake/build/bin/difftest-interpreter

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: v1.5.0

      - name: Install solc
        run: |
          sudo curl -L https://binaries.soliditylang.org/linux-amd64/solc-linux-amd64-v0.8.33+commit.64118f21 -o /usr/local/bin/solc
          sudo chmod +x /usr/local/bin/solc
          solc --version

      - name: Run tests with seed ${{ matrix.seed }}
        env:
          DIFFTEST_RANDOM_SMALL: "100"
          DIFFTEST_RANDOM_LARGE: "10000"
          DIFFTEST_RANDOM_SEED: "${{ matrix.seed }}"
          DIFFTEST_SHARD_COUNT: "1"  # No sharding for multi-seed tests
          DIFFTEST_SHARD_INDEX: "0"
        run: |
          echo "::group::Testing with seed ${{ matrix.seed }}"
          echo "DIFFTEST_RANDOM_SEED=${{ matrix.seed }}"
          # Skip Random10000 tests in multi-seed to avoid out-of-gas errors
          # See issue #96 for details
          forge test --no-match-test "Random10000"
          echo "::endgroup::"

      - name: Report seed-specific failure
        if: failure()
        run: |
          echo "::error::Tests failed with seed ${{ matrix.seed }}"
          echo "::notice::Reproduce locally: DIFFTEST_RANDOM_SEED=${{ matrix.seed }} forge test"
